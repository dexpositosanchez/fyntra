<div class="pedidos-container">
  <header class="app-header">
    <div class="header-left">
      <div class="logo-section">
        <img src="/assets/images/Isotipo.png" alt="Fyntra" class="logo-isotipo" />
      </div>
      <nav class="main-nav">
        <a routerLink="/conductores" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">CONDUCTORES</a>
        <a routerLink="/vehiculos" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">VEHÍCULOS</a>
        <a routerLink="/mantenimientos" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">MANTENIMIENTOS</a>
        <a routerLink="/rutas" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">RUTAS</a>
        <a routerLink="/pedidos" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">PEDIDOS</a>
      </nav>
    </div>
    <div class="user-section">
      <div class="user-menu-container">
        <button class="user-menu-button" (click)="toggleMenuUsuario()" title="Menú de usuario">
          <span class="user-icon app-icon">person</span>
          <span class="user-name">{{ usuario?.nombre || 'Usuario' }}</span>
          <span class="dropdown-arrow">{{ mostrarMenuUsuario ? '▲' : '▼' }}</span>
        </button>
        <div class="user-menu-dropdown" *ngIf="mostrarMenuUsuario">
          <button class="menu-item" *ngIf="estaEnModuloTransportes()" (click)="cambiarAModuloFincas()">
            <span class="menu-icon app-icon">apartment</span>
            <span>Módulo Fincas</span>
          </button>
          <button class="menu-item" *ngIf="!estaEnModuloTransportes()" (click)="cambiarAModuloTransportes()">
            <span class="menu-icon app-icon">local_shipping</span>
            <span>Módulo Transportes</span>
          </button>
          <div class="menu-divider" *ngIf="estaEnModuloTransportes() || !estaEnModuloTransportes()"></div>
          <button class="menu-item" *ngIf="usuario?.rol === 'super_admin'" (click)="irAUsuarios()">
            <span class="menu-icon app-icon">people</span>
            <span>Gestión de Usuarios</span>
          </button>
          <div class="menu-divider" *ngIf="usuario?.rol === 'super_admin'"></div>
          <button class="menu-item logout-item" (click)="logout()">
            <span class="menu-icon app-icon">logout</span>
            <span>Salir</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <!-- Sección de Pedidos -->
    <div *ngIf="currentRoute.includes('/pedidos')">
      <div class="form-container" *ngIf="mostrarFormulario">
        <h2 class="form-title">{{ editandoPedido ? 'EDITAR PEDIDO' : 'NUEVO PEDIDO' }}</h2>
        
        <form (ngSubmit)="onSubmit()" class="pedido-form">
          <div class="form-row">
            <div class="form-group">
              <label>Origen</label>
              <input
                type="text"
                [(ngModel)]="pedidoForm.origen"
                name="origen"
                placeholder="Ej: Calle Mayor 123, Madrid"
                class="form-input"
                required
              />
            </div>
            <div class="form-group">
              <label>Destino</label>
              <input
                type="text"
                [(ngModel)]="pedidoForm.destino"
                name="destino"
                placeholder="Ej: Avenida de la Paz 45, Barcelona"
                class="form-input"
                required
              />
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Cliente</label>
              <input
                type="text"
                [(ngModel)]="pedidoForm.cliente"
                name="cliente"
                placeholder="Ej: Empresa Logística SL"
                class="form-input"
                required
              />
            </div>
            <div class="form-group">
              <label>Fecha de Entrega Deseada</label>
              <input
                type="date"
                lang="es-ES"
                [(ngModel)]="pedidoForm.fecha_entrega_deseada"
                name="fecha_entrega_deseada"
                class="form-input"
                required
              />
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Volumen (m³)</label>
              <input
                type="number"
                [(ngModel)]="pedidoForm.volumen"
                name="volumen"
                placeholder="Ej: 15.5"
                class="form-input"
                min="0"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label>Peso (kg)</label>
              <input
                type="number"
                [(ngModel)]="pedidoForm.peso"
                name="peso"
                placeholder="Ej: 850.0"
                class="form-input"
                min="0"
                step="0.01"
              />
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Tipo de Mercancía</label>
              <input
                type="text"
                [(ngModel)]="pedidoForm.tipo_mercancia"
                name="tipo_mercancia"
                placeholder="Ej: Electrodomésticos"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label>Estado</label>
              <select
                [(ngModel)]="pedidoForm.estado"
                name="estado"
                class="form-input"
              >
                <option *ngFor="let estado of estados" [value]="estado.value">
                  {{ estado.label }}
                </option>
              </select>
            </div>
          </div>
          
          <div *ngIf="error" class="error-message">{{ error }}</div>
          
          <div class="form-actions">
            <button type="button" class="cancel-button" (click)="cancelarForm()">Cancelar</button>
            <button type="submit" class="submit-button" [disabled]="loading">
              {{ loading ? 'Guardando...' : (editandoPedido ? 'GUARDAR CAMBIOS' : 'CREAR PEDIDO') }}
            </button>
          </div>
        </form>
      </div>

      <div class="list-container" *ngIf="!mostrarFormulario">
        <div class="list-header">
          <h2>Pedidos</h2>
          <button class="add-button" (click)="mostrarForm()">+ Nuevo Pedido</button>
        </div>
        
        <div *ngIf="loading" class="loading">Cargando...</div>
        <div *ngIf="error" class="error">{{ error }}</div>
        
        <div class="pedidos-grid" *ngIf="!loading && !error">
          <div class="pedido-card" *ngFor="let pedido of pedidos" (click)="editarPedido(pedido)">
            <div class="card-header">
              <h3>{{ pedido.cliente }}</h3>
              <button class="delete-button" (click)="eliminarPedido(pedido, $event)" title="Eliminar pedido">
                <span class="app-icon">delete</span>
              </button>
            </div>
            <p><strong>Origen:</strong> {{ pedido.origen }}</p>
            <p><strong>Destino:</strong> {{ pedido.destino }}</p>
            <div class="pedido-details">
              <p *ngIf="pedido.volumen"><strong>Volumen:</strong> {{ pedido.volumen }} m³</p>
              <p *ngIf="pedido.peso"><strong>Peso:</strong> {{ pedido.peso }} kg</p>
              <p *ngIf="pedido.tipo_mercancia"><strong>Tipo:</strong> {{ pedido.tipo_mercancia }}</p>
              <p><strong>Entrega:</strong> {{ formatearFecha(pedido.fecha_entrega_deseada) }}</p>
            </div>
            <span [class]="'status-badge ' + getEstadoClass(pedido.estado)">
              {{ getEstadoTexto(pedido.estado) }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

