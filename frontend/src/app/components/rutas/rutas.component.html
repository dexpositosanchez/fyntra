<div class="rutas-container">
  <header class="app-header">
    <div class="header-left">
      <div class="logo-section">
        <img src="/assets/images/Isotipo.png" alt="Fyntra" class="logo-isotipo" />
      </div>
      <nav class="main-nav">
        <a routerLink="/conductores" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">CONDUCTORES</a>
        <a routerLink="/vehiculos" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">VEHÍCULOS</a>
        <a routerLink="/mantenimientos" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">MANTENIMIENTOS</a>
        <a routerLink="/rutas" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">RUTAS</a>
        <a routerLink="/pedidos" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">PEDIDOS</a>
      </nav>
    </div>
    <div class="user-section">
      <div class="user-menu-container">
        <button class="user-menu-button" (click)="toggleMenuUsuario()" title="Menú de usuario">
          <span class="user-icon app-icon">person</span>
          <span class="user-name">{{ usuario?.nombre || 'Usuario' }}</span>
          <span class="dropdown-arrow">{{ mostrarMenuUsuario ? '▲' : '▼' }}</span>
        </button>
        <div class="user-menu-dropdown" *ngIf="mostrarMenuUsuario">
          <button class="menu-item" *ngIf="estaEnModuloTransportes()" (click)="cambiarAModuloFincas()">
            <span class="menu-icon app-icon">apartment</span>
            <span>Módulo Fincas</span>
          </button>
          <button class="menu-item" *ngIf="!estaEnModuloTransportes()" (click)="cambiarAModuloTransportes()">
            <span class="menu-icon app-icon">local_shipping</span>
            <span>Módulo Transportes</span>
          </button>
          <div class="menu-divider" *ngIf="estaEnModuloTransportes() || !estaEnModuloTransportes()"></div>
          <button class="menu-item" *ngIf="usuario?.rol === 'super_admin'" (click)="irAUsuarios()">
            <span class="menu-icon app-icon">people</span>
            <span>Gestión de Usuarios</span>
          </button>
          <div class="menu-divider" *ngIf="usuario?.rol === 'super_admin'"></div>
          <button class="menu-item logout-item" (click)="logout()">
            <span class="menu-icon app-icon">logout</span>
            <span>Salir</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <!-- Sección de Rutas -->
    <div *ngIf="currentRoute.includes('/rutas')">
      <div class="form-container" *ngIf="mostrarFormulario">
        <h2 class="form-title">{{ editandoRuta ? 'EDITAR RUTA' : 'NUEVA RUTA' }}</h2>
        
        <form (ngSubmit)="onSubmit()" class="ruta-form">
          <div class="form-row">
            <div class="form-group">
              <label>Fecha de Inicio (Salida desde empresa)</label>
              <input
                type="date"
                lang="es-ES"
                [(ngModel)]="rutaForm.fecha_inicio"
                name="fecha_inicio"
                class="form-input"
                required
              />
            </div>
            <div class="form-group">
              <label>Fecha de Fin (Llegada a empresa)</label>
              <input
                type="date"
                lang="es-ES"
                [(ngModel)]="rutaForm.fecha_fin"
                name="fecha_fin"
                class="form-input"
                required
              />
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Conductor</label>
              <select
                [(ngModel)]="rutaForm.conductor_id"
                name="conductor_id"
                class="form-input"
                required
              >
                <option value="">Seleccionar conductor...</option>
                <option *ngFor="let conductor of conductores" [value]="conductor.id">
                  {{ conductor.nombre }} {{ conductor.apellidos }} - {{ conductor.licencia }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label>Vehículo</label>
              <select
                [(ngModel)]="rutaForm.vehiculo_id"
                name="vehiculo_id"
                class="form-input"
                required
              >
                <option value="">Seleccionar vehículo...</option>
                <option *ngFor="let vehiculo of vehiculos" [value]="vehiculo.id">
                  {{ vehiculo.nombre }} - {{ vehiculo.matricula }} ({{ vehiculo.capacidad }} kg)
                </option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Observaciones</label>
              <input
                type="text"
                [(ngModel)]="rutaForm.observaciones"
                name="observaciones"
                placeholder="Observaciones opcionales"
                class="form-input"
              />
            </div>
          </div>
          
          <div class="pedidos-section">
            <div class="pedidos-header">
              <h3>Pedidos</h3>
              <p class="info-text">Se crearán automáticamente paradas de carga (origen) y descarga (destino) para cada pedido. Las paradas con la misma dirección se unirán.</p>
            </div>
            
            <div class="form-group">
              <label>Añadir Pedido</label>
              <div class="pedido-select-container">
                <select
                  [(ngModel)]="pedidoSeleccionado"
                  name="pedido_seleccionar"
                  class="form-input"
                >
                  <option value="">Seleccionar pedido para añadir...</option>
                  <option *ngFor="let pedido of getPedidosDisponibles()" [ngValue]="pedido.id">
                    {{ pedido.cliente }} - {{ pedido.origen }} → {{ pedido.destino }} ({{ pedido.peso || 0 }} kg)
                  </option>
                </select>
                <button 
                  type="button" 
                  class="add-pedido-button"
                  (click)="onAnadirPedido()"
                  [disabled]="!pedidoSeleccionado"
                >
                  + Añadir
                </button>
              </div>
            </div>
            
            <div class="pedido-fechas-container" *ngIf="mostrarFechasPedido && pedidoSeleccionado && !rutaForm.pedidos_ids.includes(pedidoSeleccionado)">
              <div class="form-group">
                <label>Fecha y Hora Aproximada de Carga (Origen)</label>
                <input
                  type="datetime-local"
                  lang="es-ES"
                  [(ngModel)]="fechaHoraCarga"
                  name="fecha_hora_carga"
                  class="form-input"
                />
              </div>
              
              <div class="form-group">
                <label>Fecha y Hora Aproximada de Descarga (Destino)</label>
                <input
                  type="datetime-local"
                  lang="es-ES"
                  [(ngModel)]="fechaHoraDescarga"
                  name="fecha_hora_descarga"
                  class="form-input"
                />
              </div>
              
              <div class="pedido-fechas-actions">
                <button 
                  type="button" 
                  class="confirm-pedido-button"
                  (click)="confirmarAnadirPedido()"
                >
                  Confirmar
                </button>
                <button 
                  type="button" 
                  class="cancel-pedido-button"
                  (click)="cancelarAnadirPedido()"
                >
                  Cancelar
                </button>
              </div>
            </div>

            <div class="paradas-preview-form" *ngIf="paradasPreview.length > 0">
              <h4>Paradas creadas</h4>
              <p class="info-text">Arrastra y suelta las paradas para reordenarlas</p>
              <div class="paradas-list">
                <div 
                  class="parada-item draggable" 
                  *ngFor="let parada of paradasPreview; let i = index"
                  draggable="true"
                  (dragstart)="onDragStart($event, i)"
                  (dragend)="onDragEnd($event)"
                  (dragover)="onDragOver($event, i)"
                  (drop)="onDrop($event, i)"
                  [class.dragging]="draggedIndex === i"
                >
                  <div class="parada-drag-handle">
                    <span class="app-icon">drag_handle</span>
                  </div>
                  <div class="parada-orden">#{{ parada.orden }}</div>
                  <div class="parada-detalle">
                    <div class="parada-tipo" [class.carga]="parada.tipo_operacion === 'carga'" [class.descarga]="parada.tipo_operacion === 'descarga'">
                      {{ parada.etiqueta }} · {{ parada.tipo_operacion === 'carga' ? 'Carga' : 'Descarga' }}
                    </div>
                    <div class="parada-direccion">{{ parada.direccion }}</div>
                    <div class="parada-pedido" *ngIf="parada.pedido_id">Pedido: #{{ parada.pedido_id }}</div>
                    <div class="parada-fecha" *ngIf="parada.fecha_hora_llegada">
                      {{ formatearFechaHora(parada.fecha_hora_llegada) }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="pedidos-seleccionados" *ngIf="pedidosSeleccionados.length > 0">
              <h4>Pedidos Seleccionados ({{ pedidosSeleccionados.length }})</h4>
              <div class="pedidos-list">
                <div class="pedido-item" *ngFor="let pedido of pedidosSeleccionados">
                  <div class="pedido-info">
                    <strong>{{ pedido.cliente }}</strong>
                    <p class="pedido-ruta">
                      <span class="app-icon">location_on</span>
                      {{ pedido.origen }} → {{ pedido.destino }}
                    </p>
                    <p class="pedido-peso">
                      <span class="app-icon">inventory_2</span>
                      {{ pedido.peso || 0 }} kg | {{ pedido.volumen || 0 }} m³
                    </p>
                    <div class="pedido-fechas" *ngIf="pedidosConFechas.has(pedido.id)">
                      <p class="pedido-fecha" *ngIf="pedidosConFechas.get(pedido.id)?.fechaCarga">
                        <span class="app-icon">download</span>
                        Carga: {{ formatearFechaHora(pedidosConFechas.get(pedido.id)!.fechaCarga) }}
                      </p>
                      <p class="pedido-fecha" *ngIf="pedidosConFechas.get(pedido.id)?.fechaDescarga">
                        <span class="app-icon">upload</span>
                        Descarga: {{ formatearFechaHora(pedidosConFechas.get(pedido.id)!.fechaDescarga) }}
                      </p>
                    </div>
                  </div>
                  <button type="button" class="remove-pedido-button" (click)="eliminarPedido(pedido.id)">
                    <span class="app-icon">close</span>
                  </button>
                </div>
              </div>
              <div class="peso-total" *ngIf="rutaForm.vehiculo_id">
                <p><strong>Peso Total:</strong> {{ calcularPesoTotal() }} kg</p>
                <p *ngIf="getVehiculoSeleccionado()">
                  <strong>Capacidad Vehículo:</strong> {{ getCapacidadVehiculo() }} kg
                  <span [class]="hayExcesoCapacidad() ? 'exceso' : 'ok'">
                    ({{ hayExcesoCapacidad() ? 'EXCEDE' : 'OK' }})
                  </span>
                </p>
              </div>
            </div>
            <p class="no-pedidos" *ngIf="pedidosSeleccionados.length === 0">
              No hay pedidos seleccionados. Selecciona pedidos del menú desplegable para añadirlos a la ruta.
            </p>
          </div>
          
          <div *ngIf="error" class="error-message">{{ error }}</div>
          
          <div class="form-actions">
            <button type="button" class="cancel-button" (click)="cancelarForm()">Cancelar</button>
            <button type="submit" class="submit-button" [disabled]="loading">
              {{ loading ? 'Guardando...' : (editandoRuta ? 'GUARDAR CAMBIOS' : 'CREAR RUTA') }}
            </button>
          </div>
        </form>
      </div>

      <div class="list-container" *ngIf="!mostrarFormulario">
        <div class="list-header">
          <h2>Rutas</h2>
          <button class="add-button" (click)="mostrarForm()">+ Nueva Ruta</button>
        </div>
        
      <div *ngIf="loading" class="loading">Cargando...</div>
      <div *ngIf="error" class="error">{{ error }}</div>
      
      <div *ngIf="!loading && !error">
        <!-- Pestañas por estado -->
        <div class="tabs-container" *ngIf="tabs.length > 0">
          <div class="tabs">
            <button 
              *ngFor="let tab of tabs"
              class="tab-button"
              [class.active]="tabActiva === tab.estado"
              (click)="cambiarTab(tab.estado)">
              {{ tab.label }} ({{ tab.count }})
            </button>
          </div>
        </div>

        <!-- Contenido de la pestaña activa -->
        <div *ngIf="tabActiva && tabs.length > 0">
          <div class="rutas-grid" *ngIf="getRutasTabActiva().length > 0">
            <div class="ruta-card" *ngFor="let ruta of getRutasTabActiva()">
            <div class="ruta-header">
              <h3 (click)="editarRuta(ruta)" style="cursor: pointer;">Ruta #{{ ruta.id }}</h3>
              <div class="ruta-actions">
                <button 
                  type="button" 
                  class="delete-ruta-button" 
                  (click)="eliminarRuta(ruta.id, $event)"
                  title="Eliminar ruta"
                >
                  <span class="app-icon">delete</span>
                </button>
              </div>
            </div>
            <p *ngIf="ruta.fecha_inicio">
              <strong>Salida:</strong> {{ formatearFechaHora(ruta.fecha_inicio) }}
            </p>
            <p *ngIf="ruta.fecha_fin">
              <strong>Llegada:</strong> {{ formatearFechaHora(ruta.fecha_fin) }}
            </p>
            <p *ngIf="ruta.conductor">
              <strong>Conductor:</strong> {{ ruta.conductor.nombre }} {{ ruta.conductor.apellidos }}
            </p>
            <p *ngIf="ruta.vehiculo">
              <strong>Vehículo:</strong> {{ ruta.vehiculo.nombre }} ({{ ruta.vehiculo.matricula }})
            </p>
            <p *ngIf="ruta.paradas && ruta.paradas.length > 0">
              <strong>Paradas:</strong> {{ ruta.paradas.length }} ({{ contarParadasCarga(ruta.paradas) }} carga, {{ contarParadasDescarga(ruta.paradas) }} descarga)
            </p>
            <p *ngIf="ruta.observaciones">
              <strong>Observaciones:</strong> {{ ruta.observaciones }}
            </p>
          </div>
        </div>
          </div>
          <div *ngIf="getRutasTabActiva().length === 0" class="no-items">
            <p>No hay rutas registradas.</p>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

