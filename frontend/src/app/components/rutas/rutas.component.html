<div class="rutas-container">
  <header class="app-header">
    <div class="header-left">
      <div class="logo-section">
        <img src="/assets/images/Isotipo.png" alt="Fyntra" class="logo-isotipo" />
      </div>
      <nav class="main-nav">
        <a routerLink="/conductores" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">CONDUCTORES</a>
        <a routerLink="/vehiculos" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">VEH√çCULOS</a>
        <a routerLink="/rutas" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">RUTAS</a>
        <a routerLink="/pedidos" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">PEDIDOS</a>
      </nav>
    </div>
    <div class="user-section">
      <div class="user-menu-container">
        <button class="user-menu-button" (click)="toggleMenuUsuario()" title="Men√∫ de usuario">
          <span class="user-icon">üë§</span>
          <span class="user-name">{{ usuario?.nombre || 'Usuario' }}</span>
          <span class="dropdown-arrow">{{ mostrarMenuUsuario ? '‚ñ≤' : '‚ñº' }}</span>
        </button>
        <div class="user-menu-dropdown" *ngIf="mostrarMenuUsuario">
          <button class="menu-item" *ngIf="estaEnModuloTransportes()" (click)="cambiarAModuloFincas()">
            <span class="menu-icon">üè¢</span>
            <span>M√≥dulo Fincas</span>
          </button>
          <button class="menu-item" *ngIf="!estaEnModuloTransportes()" (click)="cambiarAModuloTransportes()">
            <span class="menu-icon">üöö</span>
            <span>M√≥dulo Transportes</span>
          </button>
          <div class="menu-divider" *ngIf="estaEnModuloTransportes() || !estaEnModuloTransportes()"></div>
          <button class="menu-item logout-item" (click)="logout()">
            <span class="menu-icon">üö™</span>
            <span>Salir</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <!-- Secci√≥n de Rutas -->
    <div *ngIf="currentRoute.includes('/rutas')">
      <div class="form-container" *ngIf="mostrarFormulario">
        <h2 class="form-title">{{ editandoRuta ? 'EDITAR RUTA' : 'NUEVA RUTA' }}</h2>
        
        <form (ngSubmit)="onSubmit()" class="ruta-form">
          <div class="form-row">
            <div class="form-group">
              <label>Fecha de Inicio (Salida desde empresa)</label>
              <input
                type="date"
                [(ngModel)]="rutaForm.fecha_inicio"
                name="fecha_inicio"
                class="form-input"
                required
              />
            </div>
            <div class="form-group">
              <label>Fecha de Fin (Llegada a empresa)</label>
              <input
                type="date"
                [(ngModel)]="rutaForm.fecha_fin"
                name="fecha_fin"
                class="form-input"
                required
              />
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Conductor</label>
              <select
                [(ngModel)]="rutaForm.conductor_id"
                name="conductor_id"
                class="form-input"
                required
              >
                <option value="">Seleccionar conductor...</option>
                <option *ngFor="let conductor of conductores" [value]="conductor.id">
                  {{ conductor.nombre }} {{ conductor.apellidos }} - {{ conductor.licencia }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label>Veh√≠culo</label>
              <select
                [(ngModel)]="rutaForm.vehiculo_id"
                name="vehiculo_id"
                class="form-input"
                required
              >
                <option value="">Seleccionar veh√≠culo...</option>
                <option *ngFor="let vehiculo of vehiculos" [value]="vehiculo.id">
                  {{ vehiculo.nombre }} - {{ vehiculo.matricula }} ({{ vehiculo.capacidad }} kg)
                </option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Observaciones</label>
              <input
                type="text"
                [(ngModel)]="rutaForm.observaciones"
                name="observaciones"
                placeholder="Observaciones opcionales"
                class="form-input"
              />
            </div>
          </div>
          
          <div class="pedidos-section">
            <div class="pedidos-header">
              <h3>Pedidos</h3>
              <p class="info-text">Se crear√°n autom√°ticamente paradas de carga (origen) y descarga (destino) para cada pedido. Las paradas con la misma direcci√≥n se unir√°n.</p>
            </div>
            
            <div class="form-group">
              <label>A√±adir Pedido</label>
              <div class="pedido-select-container">
                <select
                  [(ngModel)]="pedidoSeleccionado"
                  name="pedido_seleccionar"
                  class="form-input"
                >
                  <option value="">Seleccionar pedido para a√±adir...</option>
                  <option *ngFor="let pedido of getPedidosDisponibles()" [value]="pedido.id">
                    {{ pedido.cliente }} - {{ pedido.origen }} ‚Üí {{ pedido.destino }} ({{ pedido.peso || 0 }} kg)
                  </option>
                </select>
                <button 
                  type="button" 
                  class="add-pedido-button"
                  (click)="onAnadirPedido()"
                  [disabled]="!pedidoSeleccionado"
                >
                  + A√±adir
                </button>
              </div>
            </div>
            
            <div class="pedido-fechas-container" *ngIf="mostrarFechasPedido && pedidoSeleccionado && !rutaForm.pedidos_ids.includes(pedidoSeleccionado)">
              <div class="form-group">
                <label>Fecha y Hora Aproximada de Carga (Origen)</label>
                <input
                  type="datetime-local"
                  [(ngModel)]="fechaHoraCarga"
                  name="fecha_hora_carga"
                  class="form-input"
                />
              </div>
              
              <div class="form-group">
                <label>Fecha y Hora Aproximada de Descarga (Destino)</label>
                <input
                  type="datetime-local"
                  [(ngModel)]="fechaHoraDescarga"
                  name="fecha_hora_descarga"
                  class="form-input"
                />
              </div>
              
              <div class="pedido-fechas-actions">
                <button 
                  type="button" 
                  class="confirm-pedido-button"
                  (click)="confirmarAnadirPedido()"
                >
                  Confirmar
                </button>
                <button 
                  type="button" 
                  class="cancel-pedido-button"
                  (click)="cancelarAnadirPedido()"
                >
                  Cancelar
                </button>
              </div>
            </div>
            
            <div class="pedidos-seleccionados" *ngIf="pedidosSeleccionados.length > 0">
              <h4>Pedidos Seleccionados ({{ pedidosSeleccionados.length }})</h4>
              <div class="pedidos-list">
                <div class="pedido-item" *ngFor="let pedido of pedidosSeleccionados">
                  <div class="pedido-info">
                    <strong>{{ pedido.cliente }}</strong>
                    <p class="pedido-ruta">üìç {{ pedido.origen }} ‚Üí {{ pedido.destino }}</p>
                    <p class="pedido-peso">üì¶ {{ pedido.peso || 0 }} kg | {{ pedido.volumen || 0 }} m¬≥</p>
                    <div class="pedido-fechas" *ngIf="pedidosConFechas.has(pedido.id)">
                      <p class="pedido-fecha" *ngIf="pedidosConFechas.get(pedido.id)?.fechaCarga">
                        üì• Carga: {{ formatearFechaHora(pedidosConFechas.get(pedido.id)!.fechaCarga) }}
                      </p>
                      <p class="pedido-fecha" *ngIf="pedidosConFechas.get(pedido.id)?.fechaDescarga">
                        üì§ Descarga: {{ formatearFechaHora(pedidosConFechas.get(pedido.id)!.fechaDescarga) }}
                      </p>
                    </div>
                  </div>
                  <button type="button" class="remove-pedido-button" (click)="eliminarPedido(pedido.id)">‚úï</button>
                </div>
              </div>
              <div class="peso-total" *ngIf="rutaForm.vehiculo_id">
                <p><strong>Peso Total:</strong> {{ calcularPesoTotal() }} kg</p>
                <p *ngIf="getVehiculoSeleccionado()">
                  <strong>Capacidad Veh√≠culo:</strong> {{ getCapacidadVehiculo() }} kg
                  <span [class]="hayExcesoCapacidad() ? 'exceso' : 'ok'">
                    ({{ hayExcesoCapacidad() ? 'EXCEDE' : 'OK' }})
                  </span>
                </p>
              </div>
            </div>
            <p class="no-pedidos" *ngIf="pedidosSeleccionados.length === 0">
              No hay pedidos seleccionados. Selecciona pedidos del men√∫ desplegable para a√±adirlos a la ruta.
            </p>
          </div>
          
          <div *ngIf="error" class="error-message">{{ error }}</div>
          
          <div class="form-actions">
            <button type="button" class="cancel-button" (click)="cancelarForm()">Cancelar</button>
            <button type="submit" class="submit-button" [disabled]="loading">
              {{ loading ? 'Guardando...' : (editandoRuta ? 'GUARDAR CAMBIOS' : 'CREAR RUTA') }}
            </button>
          </div>
        </form>
      </div>

      <div class="list-container" *ngIf="!mostrarFormulario">
        <div class="list-header">
          <h2>Rutas</h2>
          <button class="add-button" (click)="mostrarForm()">+ Nueva Ruta</button>
        </div>
        
        <div *ngIf="loading" class="loading">Cargando...</div>
        <div *ngIf="error" class="error">{{ error }}</div>
        
        <div class="rutas-grid" *ngIf="!loading && !error">
          <div class="ruta-card" *ngFor="let ruta of rutas" (click)="editarRuta(ruta)">
            <div class="ruta-header">
              <h3>Ruta #{{ ruta.id }}</h3>
              <span [class]="'status-badge ' + getEstadoClass(ruta.estado)">
                {{ getEstadoTexto(ruta.estado) }}
              </span>
            </div>
            <p><strong>Fecha:</strong> {{ formatearFecha(ruta.fecha) }}</p>
            <p *ngIf="ruta.fecha_inicio">
              <strong>Salida:</strong> {{ formatearFechaHora(ruta.fecha_inicio) }}
            </p>
            <p *ngIf="ruta.fecha_fin">
              <strong>Llegada:</strong> {{ formatearFechaHora(ruta.fecha_fin) }}
            </p>
            <p *ngIf="ruta.conductor">
              <strong>Conductor:</strong> {{ ruta.conductor.nombre }} {{ ruta.conductor.apellidos }}
            </p>
            <p *ngIf="ruta.vehiculo">
              <strong>Veh√≠culo:</strong> {{ ruta.vehiculo.nombre }} ({{ ruta.vehiculo.matricula }})
            </p>
            <p *ngIf="ruta.paradas && ruta.paradas.length > 0">
              <strong>Paradas:</strong> {{ ruta.paradas.length }} ({{ contarParadasCarga(ruta.paradas) }} carga, {{ contarParadasDescarga(ruta.paradas) }} descarga)
            </p>
            <div *ngIf="ruta.paradas && ruta.paradas.length > 0" class="paradas-preview">
              <strong>Ruta:</strong>
              <div class="paradas-mini">
                <div class="parada-mini" *ngFor="let parada of ruta.paradas">
                  <div class="parada-info-mini">
                    <div class="parada-header">
                      <span class="parada-orden">#{{ parada.orden }}</span>
                      <span class="parada-tipo">{{ parada.tipo_operacion === 'carga' ? 'üì• CARGA' : 'üì§ DESCARGA' }}</span>
                    </div>
                    <div class="parada-direccion">{{ parada.direccion }}</div>
                    <div class="parada-pedidos">
                      <span class="pedido-badge" *ngFor="let pedido of (parada.pedidos || (parada.pedido ? [parada.pedido] : []))">
                        {{ pedido.cliente }}
                      </span>
                    </div>
                    <div class="parada-hora-container">
                      <input
                        type="datetime-local"
                        [value]="getFechaHoraLocal(parada.fecha_hora_llegada)"
                        (change)="actualizarFechaHoraParada(ruta.id, parada.id, $any($event.target).value)"
                        class="parada-hora-input"
                        placeholder="Fecha/hora llegada"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <p *ngIf="ruta.observaciones">
              <strong>Observaciones:</strong> {{ ruta.observaciones }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

