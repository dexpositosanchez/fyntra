<div class="rutas-container">
  <header class="app-header">
    <div class="header-left">
      <div class="logo-section">
        <img src="/assets/images/Isotipo.png" alt="Fyntra" class="logo-isotipo" />
      </div>
      <nav class="main-nav">
        <a routerLink="/conductores" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">CONDUCTORES</a>
        <a routerLink="/vehiculos" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">VEHÍCULOS</a>
        <a routerLink="/mantenimientos" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">MANTENIMIENTOS</a>
        <a routerLink="/rutas" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">RUTAS</a>
        <a routerLink="/pedidos" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">PEDIDOS</a>
        <a routerLink="/historial" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">HISTORIAL</a>
      </nav>
    </div>
    <div class="user-section">
      <div class="user-menu-container">
        <button class="user-menu-button" (click)="toggleMenuUsuario()" title="Menú de usuario">
          <span class="user-icon app-icon">person</span>
          <span class="user-name">{{ usuario?.nombre || 'Usuario' }}</span>
          <span class="dropdown-arrow">{{ mostrarMenuUsuario ? '▲' : '▼' }}</span>
        </button>
        <div class="user-menu-dropdown" *ngIf="mostrarMenuUsuario">
          <button class="menu-item" *ngIf="estaEnModuloTransportes()" (click)="cambiarAModuloFincas()">
            <span class="menu-icon app-icon">apartment</span>
            <span>Módulo Fincas</span>
          </button>
          <button class="menu-item" *ngIf="!estaEnModuloTransportes()" (click)="cambiarAModuloTransportes()">
            <span class="menu-icon app-icon">local_shipping</span>
            <span>Módulo Transportes</span>
          </button>
          <div class="menu-divider" *ngIf="estaEnModuloTransportes() || !estaEnModuloTransportes()"></div>
          <button class="menu-item" *ngIf="usuario?.rol === 'super_admin'" (click)="irAUsuarios()">
            <span class="menu-icon app-icon">people</span>
            <span>Gestión de Usuarios</span>
          </button>
          <div class="menu-divider" *ngIf="usuario?.rol === 'super_admin'"></div>
          <button class="menu-item logout-item" (click)="logout()">
            <span class="menu-icon app-icon">logout</span>
            <span>Salir</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <!-- Sección de Rutas -->
    <div *ngIf="currentRoute.includes('/rutas')">
      <div class="form-container" *ngIf="mostrarFormulario">
        <h2 class="form-title">{{
          editandoRuta
            ? (rutaActual?.estado === 'en_curso'
                ? 'VER RUTA EN PROGRESO'
                : (rutaActual?.estado === 'completada' ? 'VER RUTA FINALIZADA' : 'EDITAR RUTA'))
            : 'NUEVA RUTA'
        }}</h2>
        
        <form (ngSubmit)="onSubmit()" class="ruta-form" [class.form-disabled]="rutaActual?.estado === 'en_curso' || rutaActual?.estado === 'completada'">
          <div class="form-row">
            <div class="form-group">
              <label>Fecha de Inicio (Salida desde empresa)</label>
              <input
                type="date"
                lang="es-ES"
                [(ngModel)]="rutaForm.fecha_inicio"
                name="fecha_inicio"
                class="form-input"
                [disabled]="rutaActual?.estado === 'en_curso' || rutaActual?.estado === 'completada'"
                required
              />
            </div>
            <div class="form-group">
              <label>Fecha de Fin (Llegada a empresa)</label>
              <input
                type="date"
                lang="es-ES"
                [(ngModel)]="rutaForm.fecha_fin"
                name="fecha_fin"
                class="form-input"
                [disabled]="rutaActual?.estado === 'en_curso' || rutaActual?.estado === 'completada'"
                required
              />
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Conductor</label>
              <select
                [(ngModel)]="rutaForm.conductor_id"
                name="conductor_id"
                class="form-input"
                [disabled]="rutaActual?.estado === 'en_curso' || rutaActual?.estado === 'completada'"
                required
              >
                <option value="">Seleccionar conductor...</option>
                <option *ngFor="let conductor of conductores" [value]="conductor.id">
                  {{ conductor.nombre }} {{ conductor.apellidos }} - {{ conductor.licencia }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label>Vehículo</label>
              <select
                [(ngModel)]="rutaForm.vehiculo_id"
                name="vehiculo_id"
                class="form-input"
                (change)="onVehiculoChange()"
                [disabled]="rutaActual?.estado === 'en_curso' || rutaActual?.estado === 'completada'"
                required
              >
                <option value="">Seleccionar vehículo...</option>
                <option *ngFor="let vehiculo of vehiculos" [value]="vehiculo.id">
                  {{ vehiculo.nombre }} - {{ vehiculo.matricula }} ({{ vehiculo.capacidad }} kg)
                </option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Observaciones</label>
              <input
                type="text"
                [(ngModel)]="rutaForm.observaciones"
                name="observaciones"
                placeholder="Observaciones opcionales"
                class="form-input"
                [disabled]="rutaActual?.estado === 'en_curso' || rutaActual?.estado === 'completada'"
              />
            </div>
          </div>
          
          <!-- Sección de seguimiento (en progreso, finalizadas y canceladas) -->
          <div class="progreso-section" *ngIf="rutaActual?.estado === 'en_curso' || rutaActual?.estado === 'completada' || rutaActual?.estado === 'cancelada'">
            <h3>Progreso de la Ruta</h3>
            <div class="progreso-info">
              <p><strong>Estado:</strong> {{ getEstadoTexto(rutaActual?.estado) }}</p>
              <p *ngIf="rutaActual?.fecha_inicio"><strong>Iniciada:</strong> {{ rutaActual.fecha_inicio }}</p>
              <p *ngIf="rutaActual?.estado === 'completada' && rutaActual?.fecha_fin"><strong>Finalizada:</strong> {{ rutaActual.fecha_fin }}</p>
              <p><strong>Paradas completadas:</strong> {{ getParadasCompletadas() }} / {{ getTotalParadas() }}</p>
            </div>
            
            <div class="paradas-progreso" *ngIf="rutaActual?.paradas">
              <h4>Paradas</h4>
              <div class="parada-progreso-item" *ngFor="let parada of getParadasOrdenadas()">
                <div class="parada-progreso-header">
                  <span class="parada-orden">#{{ parada.orden }}</span>
                  <span class="parada-tipo-badge" [class.carga]="parada.tipo_operacion === 'carga'" [class.descarga]="parada.tipo_operacion === 'descarga'">
                    {{ parada.tipo_operacion === 'carga' ? 'Carga' : 'Descarga' }}
                  </span>
                  <span class="parada-estado-badge" [class.completada]="parada.estado === 'entregado'">
                    {{ parada.estado === 'entregado' ? 'Completada' : 'Pendiente' }}
                  </span>
                </div>
                <div class="parada-progreso-content">
                  <p><strong>Dirección:</strong> {{ parada.direccion }}</p>
                  <p *ngIf="parada.fecha_hora_completada"><strong>Completada:</strong> {{ parada.fecha_hora_completada }}</p>
                  <div class="parada-evidencias" *ngIf="parada.estado === 'entregado'">
                    <a *ngIf="parada.ruta_foto" [href]="getUrlFoto(parada.ruta_foto, parada.id)" target="_blank" class="evidencia-icon-link" title="Ver foto">
                      <span class="app-icon">photo_camera</span>
                    </a>
                    <a *ngIf="parada.ruta_firma" [href]="getUrlFirma(parada.ruta_firma, parada.id)" target="_blank" class="evidencia-icon-link" title="Ver firma">
                      <span class="app-icon">draw</span>
                    </a>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Incidencias (debajo de las paradas) -->
            <div class="incidencias-progreso" *ngIf="rutaActual?.incidencias && rutaActual.incidencias.length > 0">
              <h4>Incidencias ({{ rutaActual.incidencias.length }})</h4>
              <div class="incidencia-progreso-item" *ngFor="let incidencia of rutaActual.incidencias">
                <div class="incidencia-progreso-header">
                  <span class="incidencia-tipo-badge">{{ formatearTipoIncidencia(incidencia.tipo) }}</span>
                  <span class="incidencia-fecha">{{ formatearFechaHora(incidencia.creado_en) }}</span>
                </div>
                <div class="incidencia-progreso-content">
                  <p><strong>Descripción:</strong> {{ incidencia.descripcion }}</p>
                  <p *ngIf="incidencia.ruta_parada_id"><strong>Parada:</strong> #{{ getParadaOrden(incidencia.ruta_parada_id) }}</p>
                  <div class="incidencia-evidencias" *ngIf="incidencia.fotos && incidencia.fotos.length > 0">
                    <a *ngFor="let foto of incidencia.fotos" 
                       [href]="getUrlFotoIncidencia(incidencia.id, foto.id)" 
                       target="_blank" 
                       class="evidencia-icon-link" 
                       title="Ver foto">
                      <span class="app-icon">photo_camera</span>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="pedidos-section" *ngIf="rutaActual?.estado !== 'en_curso' && rutaActual?.estado !== 'completada'">
            <div class="pedidos-header">
              <h3>Pedidos</h3>
              <p class="info-text">Se crearán automáticamente paradas de carga (origen) y descarga (destino) para cada pedido. Las paradas con la misma dirección se unirán.</p>
            </div>
            
            <div class="form-group">
              <label>Añadir Pedido</label>
              <div class="pedido-select-container">
                <select
                  [(ngModel)]="pedidoSeleccionado"
                  name="pedido_seleccionar"
                  class="form-input"
                >
                  <option value="">Seleccionar pedido para añadir...</option>
                  <option *ngFor="let pedido of getPedidosDisponibles()" [ngValue]="pedido.id">
                    {{ pedido.cliente }} - {{ pedido.origen }} → {{ pedido.destino }} ({{ pedido.peso || 0 }} kg) - Entrega: {{ formatearFecha(pedido.fecha_entrega_deseada) }}
                  </option>
                </select>
                <button 
                  type="button" 
                  class="add-pedido-button"
                  (click)="onAnadirPedido()"
                  [disabled]="!pedidoSeleccionado"
                >
                  + Añadir
                </button>
              </div>
            </div>
            
            <div class="pedido-fechas-container" *ngIf="mostrarFechasPedido && pedidoSeleccionado && !rutaForm.pedidos_ids.includes(pedidoSeleccionado)">
              <div class="form-group">
                <label>Fecha y Hora Aproximada de Carga (Origen)</label>
                <input
                  type="datetime-local"
                  lang="es-ES"
                  [(ngModel)]="fechaHoraCarga"
                  name="fecha_hora_carga"
                  class="form-input"
                />
              </div>
              
              <div class="form-group">
                <label>Fecha y Hora Aproximada de Descarga (Destino)</label>
                <input
                  type="datetime-local"
                  lang="es-ES"
                  [(ngModel)]="fechaHoraDescarga"
                  name="fecha_hora_descarga"
                  class="form-input"
                />
              </div>
              
              <div class="pedido-fechas-actions">
                <button 
                  type="button" 
                  class="confirm-pedido-button"
                  (click)="confirmarAnadirPedido()"
                >
                  Confirmar
                </button>
                <button 
                  type="button" 
                  class="cancel-pedido-button"
                  (click)="cancelarAnadirPedido()"
                >
                  Cancelar
                </button>
              </div>
            </div>

            <div class="paradas-preview-form" *ngIf="paradasPreview.length > 0">
              <h4>Paradas creadas</h4>
              <p class="info-text">Arrastra y suelta las paradas para reordenarlas</p>
              <div class="paradas-list">
                <div 
                  class="parada-item draggable" 
                  *ngFor="let parada of paradasPreview; let i = index"
                  draggable="true"
                  (dragstart)="onDragStart($event, i)"
                  (dragend)="onDragEnd($event)"
                  (dragover)="onDragOver($event, i)"
                  (drop)="onDrop($event, i)"
                  [class.dragging]="draggedIndex === i"
                >
                  <!-- Input oculto para el orden -->
                  <input 
                    type="hidden" 
                    [value]="parada.orden" 
                    [name]="'parada_orden_' + i"
                    [(ngModel)]="parada.orden"
                  />
                  
                  <div class="parada-header">
                    <div class="parada-drag-handle">
                      <span class="app-icon">drag_handle</span>
                    </div>
                    <div class="parada-orden">#{{ parada.orden }}</div>
                    <div class="parada-tipo-badge" [class.carga]="parada.tipo_operacion === 'carga'" [class.descarga]="parada.tipo_operacion === 'descarga'">
                      {{ parada.tipo_operacion === 'carga' ? 'C' : 'D' }}
                    </div>
                  </div>
                  
                  <div class="parada-content">
                    <div class="parada-info">
                      <div class="parada-direccion">{{ parada.direccion }}</div>
                      <div class="parada-pedido" *ngIf="parada.pedido_id">Pedido #{{ parada.pedido_id }}</div>
                      <div class="parada-entrega" *ngIf="parada.fecha_entrega_deseada && parada.tipo_operacion === 'descarga'">
                        <span class="app-icon">event</span>
                        Entrega: {{ formatearFecha(parada.fecha_entrega_deseada) }}
                      </div>
                    </div>
                    <div class="parada-peso" [class.exceso]="getPesoAcumuladoEnParada(i) > getCapacidadVehiculo()">
                      {{ getPesoAcumuladoEnParada(i) }} / {{ getCapacidadVehiculo() }} kg
                    </div>
                    <div class="parada-fecha-input">
                      <input
                        type="datetime-local"
                        lang="es-ES"
                        [value]="getFechaHoraLocal(parada.fecha_hora_llegada)"
                        (change)="actualizarFechaParada(i, $event)"
                        class="fecha-parada-input"
                        placeholder="Fecha y hora"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="pedidos-seleccionados" *ngIf="pedidosSeleccionados.length > 0">
              <h4>Pedidos Seleccionados ({{ pedidosSeleccionados.length }})</h4>
              <div class="pedidos-list">
                <div class="pedido-item-compact" *ngFor="let pedido of pedidosSeleccionados">
                  <div class="pedido-header-compact">
                    <div class="pedido-cliente-compact">{{ pedido.cliente }}</div>
                    <button type="button" class="remove-pedido-button-compact" (click)="eliminarPedido(pedido.id)">
                      <span class="app-icon">close</span>
                    </button>
                  </div>
                  <div class="pedido-content-compact">
                    <div class="pedido-info-compact">
                      <div class="pedido-ruta-compact">{{ pedido.origen }} → {{ pedido.destino }}</div>
                      <div class="pedido-peso-compact">{{ pedido.peso || 0 }} kg</div>
                      <div class="pedido-entrega-compact" *ngIf="pedido.fecha_entrega_deseada">
                        <span class="app-icon">event</span>
                        {{ formatearFecha(pedido.fecha_entrega_deseada) }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="peso-info" *ngIf="rutaForm.vehiculo_id && paradasPreview.length > 0">
                <p><strong>Capacidad Vehículo:</strong> {{ getCapacidadVehiculo() }} kg</p>
                <p *ngIf="hayExcesoPesoEnAlgunaParada()" class="error-peso">
                  <span class="app-icon">warning</span>
                  <strong>¡ATENCIÓN!</strong> El peso acumulado excede la capacidad en alguna parada
                </p>
                <p *ngIf="!hayExcesoPesoEnAlgunaParada()" class="ok-peso">
                  <span class="app-icon">check_circle</span>
                  El peso acumulado está dentro de la capacidad en todas las paradas
                </p>
              </div>
            </div>
            <p class="no-pedidos" *ngIf="pedidosSeleccionados.length === 0">
              No hay pedidos seleccionados. Selecciona pedidos del menú desplegable para añadirlos a la ruta.
            </p>
          </div>
          
          <div *ngIf="error" class="error-message">{{ error }}</div>
          
          <div class="form-actions">
            <button type="button" class="cancel-button" (click)="cancelarForm()">Cancelar</button>
            <button
              type="submit"
              class="submit-button"
              [disabled]="loading || rutaActual?.estado === 'en_curso' || rutaActual?.estado === 'completada'"
              *ngIf="rutaActual?.estado !== 'en_curso' && rutaActual?.estado !== 'completada'"
            >
              {{ loading ? 'Guardando...' : (editandoRuta ? 'GUARDAR CAMBIOS' : 'CREAR RUTA') }}
            </button>
          </div>
        </form>
      </div>

      <div class="list-container" *ngIf="!mostrarFormulario">
        <div class="list-header">
          <h2>Rutas</h2>
          <button class="add-button" (click)="mostrarForm()">+ Nueva Ruta</button>
        </div>
        
      <div *ngIf="loading" class="loading">Cargando...</div>
      <div *ngIf="error" class="error">{{ error }}</div>
      
      <div *ngIf="!loading && !error">
        <!-- Sección de filtros -->
        <div class="filters-section">
          <div class="filters-row">
            <div class="filter-group">
              <label>Conductor</label>
              <select
                [(ngModel)]="filtroConductor"
                (change)="aplicarFiltros()"
                class="filter-select"
              >
                <option value="">Todos</option>
                <option *ngFor="let conductor of conductores" [value]="conductor.id">
                  {{ conductor.nombre }} {{ conductor.apellidos }} - {{ conductor.licencia }}
                </option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>Vehículo</label>
              <select
                [(ngModel)]="filtroVehiculo"
                (change)="aplicarFiltros()"
                class="filter-select"
              >
                <option value="">Todos</option>
                <option *ngFor="let vehiculo of vehiculos" [value]="vehiculo.id">
                  {{ vehiculo.nombre }} - {{ vehiculo.matricula }}
                </option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>
                <input
                  type="checkbox"
                  [(ngModel)]="filtroSoloConIncidencias"
                  (change)="aplicarFiltros()"
                />
                Solo rutas con incidencias
              </label>
            </div>
            
            <button 
              *ngIf="filtroConductor || filtroVehiculo || filtroSoloConIncidencias" 
              class="clear-filters-button" 
              (click)="limpiarTodosFiltros()"
              title="Limpiar todos los filtros"
            >
              <span class="app-icon">clear_all</span>
              Limpiar filtros
            </button>
          </div>
        </div>
        
        <!-- Pestañas por estado -->
        <div class="tabs-container" *ngIf="tabs.length > 0">
          <div class="tabs">
            <button 
              *ngFor="let tab of tabs"
              class="tab-button"
              [class.active]="tabActiva === tab.estado"
              (click)="cambiarTab(tab.estado)">
              {{ tab.label }} ({{ tab.count }})
            </button>
          </div>
        </div>

        <!-- Contenido de la pestaña activa -->
        <div *ngIf="tabActiva && tabs.length > 0">
          <div class="rutas-grid" *ngIf="getRutasTabActiva().length > 0">
            <div class="ruta-card" 
                 *ngFor="let ruta of getRutasTabActiva()"
                 [class]="'ruta-card ' + getEstadoClass(ruta.estado)"
                 [class.tiene-incidencias]="ruta.tiene_incidencias || (ruta.incidencias_count && ruta.incidencias_count > 0)">
            <div class="ruta-header">
              <h3 (click)="editarRuta(ruta)" style="cursor: pointer;">
                Ruta #{{ ruta.id }}
                <span *ngIf="ruta.tiene_incidencias || (ruta.incidencias_count && ruta.incidencias_count > 0)" 
                      class="incidencia-indicator" 
                      title="Esta ruta tiene incidencias">
                  <span class="app-icon">warning</span>
                </span>
              </h3>
              <div class="ruta-actions">
                <button 
                  type="button" 
                  class="delete-ruta-button" 
                  (click)="eliminarRuta(ruta.id, $event)"
                  title="Eliminar ruta"
                >
                  <span class="app-icon">delete</span>
                </button>
              </div>
            </div>
            <p *ngIf="ruta.fecha_inicio">
              <strong>Salida:</strong> {{ formatearFechaHora(ruta.fecha_inicio) }}
            </p>
            <p *ngIf="ruta.fecha_fin">
              <strong>Llegada:</strong> {{ formatearFechaHora(ruta.fecha_fin) }}
            </p>
            <p *ngIf="ruta.conductor">
              <strong>Conductor:</strong> {{ ruta.conductor.nombre }} {{ ruta.conductor.apellidos }}
            </p>
            <p *ngIf="ruta.vehiculo">
              <strong>Vehículo:</strong> {{ ruta.vehiculo.nombre }} ({{ ruta.vehiculo.matricula }})
            </p>
            <p *ngIf="ruta.estado">
              <strong>Estado:</strong> 
              <span [class]="'estado-' + getEstadoClass(ruta.estado)">
                {{ getEstadoTexto(ruta.estado) }}{{ getProgresoParadasTexto(ruta) }}
              </span>
            </p>
            <p *ngIf="ruta.paradas && ruta.paradas.length > 0">
              <strong>Paradas:</strong> {{ ruta.paradas.length }} ({{ contarParadasCarga(ruta.paradas) }} carga, {{ contarParadasDescarga(ruta.paradas) }} descarga)
            </p>
            <p *ngIf="ruta.observaciones">
              <strong>Observaciones:</strong> {{ ruta.observaciones }}
            </p>
          </div>
        </div>
          </div>
          <div *ngIf="getRutasTabActiva().length === 0" class="no-items">
            <p>No hay rutas registradas.</p>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

