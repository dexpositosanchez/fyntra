<div class="incidencias-container">
  <header class="app-header">
    <div class="header-left">
      <div class="logo-section">
        <img src="/assets/images/Isotipo.png" alt="Fyntra" class="logo-isotipo" />
      </div>
      <nav class="main-nav">
        <a routerLink="/incidencias" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">
          {{ esProveedor ? 'MIS INCIDENCIAS' : 'INCIDENCIAS' }}
        </a>
        <ng-container *ngIf="!esProveedor">
          <a routerLink="/inmuebles" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">{{ esPropietario ? 'MIS INMUEBLES' : 'INMUEBLES' }}</a>
          <ng-container *ngIf="!esPropietario">
            <a routerLink="/comunidades" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">COMUNIDADES</a>
            <a routerLink="/propietarios" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">PROPIETARIOS</a>
            <a routerLink="/proveedores" class="nav-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">PROVEEDORES</a>
          </ng-container>
        </ng-container>
      </nav>
    </div>
    <div class="user-section">
      <div class="user-menu-container">
        <button class="user-menu-button" (click)="toggleMenuUsuario()" title="Menú de usuario">
          <span class="user-icon app-icon">person</span>
          <span class="user-name">{{ usuario?.nombre || 'Usuario' }}</span>
          <span class="dropdown-arrow">{{ mostrarMenuUsuario ? '▲' : '▼' }}</span>
        </button>
        <div class="user-menu-dropdown" *ngIf="mostrarMenuUsuario">
          <ng-container *ngIf="!esPropietario && !esProveedor">
            <button class="menu-item" *ngIf="estaEnModuloTransportes()" (click)="cambiarAModuloFincas()">
              <span class="menu-icon app-icon">apartment</span>
              <span>Módulo Fincas</span>
            </button>
            <button class="menu-item" *ngIf="!estaEnModuloTransportes()" (click)="cambiarAModuloTransportes()">
              <span class="menu-icon app-icon">local_shipping</span>
              <span>Módulo Transportes</span>
            </button>
            <div class="menu-divider"></div>
          </ng-container>
          <button class="menu-item" *ngIf="usuario?.rol === 'super_admin'" (click)="irAUsuarios()">
            <span class="menu-icon app-icon">people</span>
            <span>Gestión de Usuarios</span>
          </button>
          <div class="menu-divider" *ngIf="usuario?.rol === 'super_admin'"></div>
          <button class="menu-item logout-item" (click)="logout()">
            <span class="menu-icon app-icon">logout</span>
            <span>Salir</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <!-- Vista de gestión de incidencia para proveedores -->
    <div class="form-container proveedor-gestion" *ngIf="esProveedor && mostrarActuaciones && incidenciaSeleccionada">
      <div class="form-header">
        <h2>Gestión de Incidencia</h2>
        <button class="close-button" (click)="cerrarActuaciones()">×</button>
      </div>
      
      <!-- Info de la incidencia -->
      <div class="incidencia-detalle">
        <h3>{{ incidenciaSeleccionada.titulo }}</h3>
        <p class="descripcion" *ngIf="incidenciaSeleccionada.descripcion">{{ incidenciaSeleccionada.descripcion }}</p>
        <div class="info-badges">
          <span [class]="'estado-badge ' + getEstadoClass(incidenciaSeleccionada.estado)">
            {{ getEstadoLabel(incidenciaSeleccionada.estado) }}
          </span>
          <span [class]="'prioridad-badge ' + getPrioridadClass(incidenciaSeleccionada.prioridad)">
            {{ getPrioridadTexto(incidenciaSeleccionada.prioridad) }}
          </span>
        </div>
        <p class="ubicacion" *ngIf="incidenciaSeleccionada.inmueble">
          <span class="app-icon">location_on</span>
          {{ incidenciaSeleccionada.inmueble?.referencia }} - {{ incidenciaSeleccionada.inmueble?.direccion }}
        </p>
      </div>

      <!-- Cambiar estado -->
      <div class="estado-section" *ngIf="incidenciaSeleccionada.estado !== 'cerrada'">
        <div class="form-group">
          <label>Estado de la incidencia</label>
          <select class="form-input" [ngModel]="incidenciaSeleccionada.estado" 
                  (ngModelChange)="cambiarEstadoProveedor($event)">
            <option value="asignada" [disabled]="incidenciaSeleccionada.estado !== 'asignada'">Asignada</option>
            <option value="en_progreso">En Progreso</option>
            <option value="resuelta">Resuelta</option>
            <option value="cerrada">Cerrada (sin solución)</option>
          </select>
        </div>
      </div>

      <!-- Sección de actuaciones -->
      <div class="actuaciones-section-form">
        <div class="section-header">
          <h4>Actuaciones realizadas</h4>
          <button class="add-actuacion-btn" (click)="mostrarFormularioActuacion()" *ngIf="!mostrarFormActuacion">
            + Nueva Actuación
          </button>
        </div>

        <!-- Formulario nueva actuación -->
        <div class="actuacion-form-inline" *ngIf="mostrarFormActuacion">
          <div class="form-group">
            <label>Descripción del trabajo realizado *</label>
            <textarea [(ngModel)]="actuacionForm.descripcion" rows="3" class="form-input"
                      placeholder="Describa detalladamente el trabajo realizado..." required></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Fecha de realización *</label>
              <input type="date" [(ngModel)]="actuacionForm.fecha" class="form-input" required>
            </div>
            <div class="form-group">
              <label>Coste (€)</label>
              <input type="number" [(ngModel)]="actuacionForm.coste" step="0.01" min="0" 
                     class="form-input" placeholder="0.00">
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="cancel-button" (click)="cancelarFormActuacion()">Cancelar</button>
            <button type="button" class="submit-button" (click)="guardarActuacion()" 
                    [disabled]="!actuacionForm.descripcion || !actuacionForm.fecha">
              GUARDAR ACTUACIÓN
            </button>
          </div>
        </div>

        <!-- Lista de actuaciones -->
        <div class="actuaciones-lista" *ngIf="actuaciones.length > 0">
          <div class="actuacion-card" *ngFor="let act of actuaciones">
            <div class="actuacion-header">
              <span class="actuacion-fecha">
                <span class="app-icon">calendar_today</span>
                {{ formatearFecha(act.fecha) }}
              </span>
              <span class="actuacion-coste" *ngIf="act.coste">{{ act.coste | number:'1.2-2' }} €</span>
              <button class="delete-btn-small" (click)="eliminarActuacion(act, $event)" title="Eliminar">
                <span class="app-icon">delete</span>
              </button>
            </div>
            <p class="actuacion-descripcion">{{ act.descripcion }}</p>
          </div>
        </div>
        
        <div class="empty-actuaciones" *ngIf="actuaciones.length === 0 && !mostrarFormActuacion">
          <span class="app-icon">build</span>
          <p>No hay actuaciones registradas</p>
          <small>Añada una actuación para documentar el trabajo realizado</small>
        </div>
      </div>

      <div *ngIf="error" class="error-message">{{ error }}</div>
      
      <div class="form-actions">
        <button type="button" class="cancel-button" (click)="cerrarActuaciones()">Volver a la lista</button>
        <button type="button" class="history-button" (click)="verHistorial(incidenciaSeleccionada, $event)" 
                *ngIf="incidenciaSeleccionada?.historial?.length > 0">
          <span class="app-icon">history</span> Ver historial ({{ incidenciaSeleccionada?.historial?.length }})
        </button>
      </div>
    </div>

    <!-- Formulario de Incidencia -->
    <div class="form-container" *ngIf="mostrarFormulario && !esProveedor">
      <div class="form-header">
        <h2>{{ editandoIncidencia ? 'Editar Incidencia' : 'Nueva Incidencia' }}</h2>
        <button class="close-button" (click)="cancelarForm()">×</button>
      </div>
      <form (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label for="titulo">Título *</label>
          <input type="text" id="titulo" [(ngModel)]="incidenciaForm.titulo" name="titulo" required class="form-input" placeholder="Descripción breve del problema">
        </div>
        
        <div class="form-group">
          <label for="descripcion">Descripción</label>
          <textarea id="descripcion" [(ngModel)]="incidenciaForm.descripcion" name="descripcion" rows="4" class="form-input" placeholder="Detalle del problema"></textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="inmueble_id">Inmueble *</label>
            <select id="inmueble_id" [(ngModel)]="incidenciaForm.inmueble_id" name="inmueble_id" required class="form-input" [disabled]="editandoIncidencia">
              <option value="">Seleccionar inmueble</option>
              <option *ngFor="let inmueble of inmuebles" [value]="inmueble.id">
                {{ inmueble.referencia }} - {{ inmueble.direccion || 'Sin dirección' }}
              </option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="prioridad">Prioridad</label>
            <select id="prioridad" [(ngModel)]="incidenciaForm.prioridad" name="prioridad" class="form-input">
              <option *ngFor="let p of prioridades" [value]="p.value">{{ p.label }}</option>
            </select>
          </div>
        </div>
        
        <div class="form-row" *ngIf="editandoIncidencia">
          <div class="form-group">
            <label for="estado">Estado</label>
            <select id="estado" [(ngModel)]="incidenciaForm.estado" name="estado" class="form-input" [disabled]="esPropietario">
              <option *ngFor="let e of estados" [value]="e.value">{{ e.label }}</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="proveedor_id">Proveedor asignado</label>
            <select id="proveedor_id" [(ngModel)]="incidenciaForm.proveedor_id" name="proveedor_id" class="form-input" [disabled]="esPropietario">
              <option [ngValue]="null">Sin asignar</option>
              <option *ngFor="let prov of proveedores" [value]="prov.id">{{ prov.nombre }}</option>
            </select>
          </div>
        </div>
        
        <div class="form-group" *ngIf="editandoIncidencia">
          <label for="comentario_cambio">Comentario del cambio</label>
          <input type="text" id="comentario_cambio" [(ngModel)]="incidenciaForm.comentario_cambio" name="comentario_cambio" class="form-input" placeholder="Motivo del cambio (opcional)" [disabled]="esPropietario">
        </div>
        
        <div *ngIf="error" class="error-message">{{ error }}</div>
        
        <div class="form-actions">
          <button type="button" class="cancel-button" (click)="cancelarForm()">Cancelar</button>
          <button type="submit" class="submit-button" [disabled]="loading">
            {{ loading ? 'Guardando...' : (editandoIncidencia ? 'GUARDAR CAMBIOS' : 'CREAR INCIDENCIA') }}
          </button>
        </div>
      </form>
    </div>

    <!-- Lista de Incidencias -->
    <div *ngIf="!mostrarFormulario && !mostrarActuaciones && currentRoute.includes('/incidencias')">
      <div class="list-header">
        <h2>{{ esProveedor ? 'Mis Incidencias Asignadas' : (esPropietario ? 'Mis Incidencias' : 'Incidencias') }}</h2>
        <div class="header-actions" *ngIf="!esProveedor">
          <button class="add-button" (click)="mostrarForm()">+ Nueva Incidencia</button>
        </div>
      </div>
      
      <div class="filters-section">
        <div class="filter-group">
          <label>Prioridad</label>
          <select [(ngModel)]="filtroPrioridad" class="filter-input">
            <option value="">Todas</option>
            <option *ngFor="let p of prioridades" [value]="p.value">{{ p.label }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Estado</label>
          <select [(ngModel)]="filtroEstado" class="filter-input">
            <option value="">Todos</option>
            <option *ngFor="let e of estados" [value]="e.value">{{ e.label }}</option>
          </select>
        </div>
      </div>

      <div *ngIf="loading" class="loading">Cargando...</div>
      <div *ngIf="error && !mostrarFormulario" class="error">{{ error }}</div>
      
      <div *ngIf="!loading && !error">
        <!-- Pestañas por estado -->
        <div class="tabs-container" *ngIf="tabs.length > 0">
          <div class="tabs">
            <button 
              *ngFor="let tab of tabs"
              class="tab-button"
              [class.active]="tabActiva === tab.estado"
              (click)="cambiarTab(tab.estado)">
              {{ tab.label }} ({{ tab.count }})
            </button>
          </div>
        </div>

        <!-- Contenido de la pestaña activa -->
        <div *ngIf="tabActiva && tabs.length > 0">
          <div class="incidencias-grid" *ngIf="getIncidenciasTabActiva().length > 0">
            <div class="incidencia-card" *ngFor="let incidencia of getIncidenciasTabActiva()"
             (click)="esProveedor ? verActuaciones(incidencia, $event) : editarIncidencia(incidencia)">
              <div class="card-header">
                <span [class]="'prioridad-badge ' + getPrioridadClass(incidencia.prioridad)">
                  {{ getPrioridadTexto(incidencia.prioridad) }}
                </span>
              </div>
              <h3 class="incidencia-titulo">{{ incidencia.titulo }}</h3>
              <p class="incidencia-inmueble" *ngIf="incidencia.inmueble">
                <span class="app-icon">home</span>
                {{ incidencia.inmueble.referencia }} - {{ incidencia.inmueble.direccion }}
              </p>
              <p class="incidencia-fecha">
                <span class="app-icon">calendar_today</span>
                {{ formatearFecha(incidencia.fecha_alta) }}
              </p>
              <div class="card-actions">
            <!-- Historial para todos -->
            <button class="action-btn history-btn" (click)="verHistorial(incidencia, $event)" title="Ver historial">
              <span class="app-icon">history</span>
              <span class="count-badge" *ngIf="incidencia.historial?.length">{{ incidencia.historial.length }}</span>
            </button>
            <!-- Actuaciones para todos -->
            <button class="action-btn actuaciones-btn" 
                    (click)="verActuaciones(incidencia, $event)" title="Ver actuaciones">
              <span class="app-icon">build</span>
              <span class="count-badge" *ngIf="incidencia.actuaciones_count">{{ incidencia.actuaciones_count }}</span>
            </button>
            <!-- Documentos para todos -->
            <button class="action-btn documentos-btn" 
                    (click)="verDocumentos(incidencia, $event)" title="Ver documentos">
              <span class="app-icon">attach_file</span>
              <span class="count-badge" *ngIf="incidencia.documentos_count">{{ incidencia.documentos_count }}</span>
            </button>
            <!-- Chat para todos -->
            <button class="action-btn chat-btn" 
                    (click)="abrirChat(incidencia, $event)" title="Chat">
              <span class="app-icon">chat</span>
            </button>
            <!-- Eliminar: admin o propietario que creó la incidencia -->
            <button class="action-btn delete-btn" 
                    *ngIf="puedeEliminarIncidencia(incidencia)" 
                    (click)="eliminarIncidencia(incidencia, $event)" 
                    title="Eliminar">
              <span class="app-icon">delete</span>
            </button>
          </div>
        </div>
          </div>
          <div *ngIf="getIncidenciasTabActiva().length === 0" class="no-items">
            <p>No hay incidencias registradas.</p>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Modal Actuaciones (para admin/propietario) -->
<div class="modal-overlay" *ngIf="mostrarActuacionesModal" (click)="cerrarActuaciones()">
  <div class="modal-content actuaciones-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Actuaciones de la incidencia</h3>
      <button class="close-button" (click)="cerrarActuaciones()">×</button>
    </div>
    <div class="modal-body">
      <div class="modal-incidencia-titulo">{{ incidenciaSeleccionada?.titulo }}</div>
      
      <div class="actuaciones-list-modal" *ngIf="actuaciones.length > 0">
        <div class="actuacion-item-modal" *ngFor="let act of actuaciones">
          <div class="actuacion-header-modal">
            <span class="actuacion-fecha-modal">
              <span class="app-icon">calendar_today</span>
              {{ formatearFecha(act.fecha) }}
            </span>
            <span class="actuacion-coste-modal" *ngIf="act.coste">{{ act.coste | number:'1.2-2' }} €</span>
          </div>
          <p class="actuacion-descripcion-modal">{{ act.descripcion }}</p>
          <div class="actuacion-proveedor-modal" *ngIf="act.proveedor">
            <span class="app-icon">person</span> {{ act.proveedor.nombre }}
          </div>
        </div>
      </div>
      
      <div class="empty-actuaciones-modal" *ngIf="actuaciones.length === 0">
        <span class="app-icon">build</span>
        <p>No hay actuaciones registradas</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal Historial -->
<div class="modal-overlay" *ngIf="mostrarHistorial" (click)="cerrarHistorial()">
  <div class="modal-content historial-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Historial de cambios</h3>
      <button class="close-button" (click)="cerrarHistorial()">×</button>
    </div>
    <div class="modal-body">
      <div class="historial-titulo">{{ incidenciaSeleccionada?.titulo }}</div>
      <div class="historial-timeline" *ngIf="incidenciaSeleccionada?.historial?.length > 0">
        <div class="historial-item" *ngFor="let h of incidenciaSeleccionada.historial">
          <div class="historial-fecha">{{ formatearFecha(h.fecha) }}</div>
          <div class="historial-cambio">
            <span *ngIf="h.estado_anterior" class="estado-anterior">{{ getEstadoLabel(h.estado_anterior) }}</span>
            <span *ngIf="h.estado_anterior" class="arrow">→</span>
            <span class="estado-nuevo">{{ getEstadoLabel(h.estado_nuevo) }}</span>
          </div>
          <div class="historial-usuario" *ngIf="h.usuario_nombre">por {{ h.usuario_nombre }}</div>
          <div class="historial-comentario" *ngIf="h.comentario">{{ h.comentario }}</div>
        </div>
      </div>
      <div class="empty-historial" *ngIf="!incidenciaSeleccionada?.historial?.length">
        No hay historial de cambios
      </div>
    </div>
  </div>
</div>

<!-- Modal Documentos -->
<div class="modal-overlay" *ngIf="mostrarDocumentosModal" (click)="cerrarDocumentos()">
  <div class="modal-content documentos-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Documentos de la incidencia</h3>
      <button class="close-button" (click)="cerrarDocumentos()">×</button>
    </div>
    <div class="modal-body">
      <div class="modal-incidencia-titulo">{{ incidenciaSeleccionada?.titulo }}</div>
      
      <!-- Botón para añadir documento -->
      <div class="documentos-header" *ngIf="!mostrarFormDocumento">
        <button class="add-documento-btn" (click)="mostrarFormularioDocumento()">
          <span class="app-icon">upload_file</span> Subir documento
        </button>
      </div>

      <!-- Formulario subir documento -->
      <div class="documento-form" *ngIf="mostrarFormDocumento">
        <div class="form-group">
          <label>Nombre del documento *</label>
          <input type="text" [(ngModel)]="documentoForm.nombre" class="form-input" 
                 placeholder="Ej: Factura reparación, Foto avería...">
        </div>
        <div class="form-group">
          <label>Archivo *</label>
          <div class="file-input-wrapper">
            <input type="file" id="archivo" (change)="onArchivoSeleccionado($event)" 
                   accept="image/*,.pdf,.doc,.docx,.xls,.xlsx">
            <label for="archivo" class="file-label">
              <span class="app-icon">cloud_upload</span>
              {{ archivoSeleccionado ? archivoSeleccionado.name : 'Seleccionar archivo' }}
            </label>
          </div>
          <small class="help-text">Formatos: imágenes, PDF, Word, Excel. Máx: 10MB</small>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn" (click)="cancelarFormDocumento()">Cancelar</button>
          <button type="button" class="save-btn" (click)="subirDocumento()" 
                  [disabled]="!documentoForm.nombre || !archivoSeleccionado || loading">
            {{ loading ? 'Subiendo...' : 'Subir documento' }}
          </button>
        </div>
      </div>

      <!-- Lista de documentos -->
      <div class="documentos-list" *ngIf="documentos.length > 0 && !mostrarFormDocumento">
        <div class="documento-item" *ngFor="let doc of documentos">
          <div class="documento-icon">
            <span class="app-icon" *ngIf="doc.tipo_archivo?.startsWith('image/')">image</span>
            <span class="app-icon" *ngIf="doc.tipo_archivo === 'application/pdf'">picture_as_pdf</span>
            <span class="app-icon" *ngIf="!doc.tipo_archivo?.startsWith('image/') && doc.tipo_archivo !== 'application/pdf'">description</span>
          </div>
          <div class="documento-info">
            <div class="documento-nombre">{{ doc.nombre }}</div>
            <div class="documento-meta">
              <span>{{ doc.nombre_archivo }}</span>
              <span *ngIf="doc.tamano">• {{ formatearTamano(doc.tamano) }}</span>
            </div>
            <div class="documento-subido">
              <span class="app-icon">person</span> {{ doc.subido_por }} • {{ formatearFecha(doc.creado_en) }}
            </div>
          </div>
          <div class="documento-actions">
            <button class="ver-btn" (click)="verDocumento(doc)" title="Ver/Descargar">
              <span class="app-icon">visibility</span>
            </button>
            <button class="delete-btn" *ngIf="puedeEliminarDocumento(doc)" 
                    (click)="eliminarDocumento(doc, $event)" title="Eliminar">
              <span class="app-icon">delete</span>
            </button>
          </div>
        </div>
      </div>

      <div class="empty-documentos" *ngIf="documentos.length === 0 && !mostrarFormDocumento">
        <span class="app-icon">folder_open</span>
        <p>No hay documentos adjuntos</p>
        <small>Sube fotos, facturas o presupuestos relacionados con la incidencia</small>
      </div>
      
      <div *ngIf="error" class="error-message">{{ error }}</div>
    </div>
  </div>
</div>

<!-- Visor de documento -->
<div class="modal-overlay visor-overlay" *ngIf="mostrarVisorDocumento" (click)="cerrarVisor()">
  <div class="visor-content" (click)="$event.stopPropagation()">
    <div class="visor-header">
      <span class="visor-titulo">{{ documentoVisualizando?.nombre }}</span>
      <button class="close-button" (click)="cerrarVisor()">×</button>
    </div>
    <div class="visor-body">
      <img *ngIf="documentoVisualizando?.tipo_archivo?.startsWith('image/')" 
           [src]="documentoVisualizando?.url" alt="{{ documentoVisualizando?.nombre }}">
      <iframe *ngIf="documentoVisualizando?.tipo_archivo === 'application/pdf'" 
              [src]="documentoVisualizando?.url" frameborder="0"></iframe>
    </div>
  </div>
</div>

<!-- Modal Chat -->
<div class="modal-overlay chat-overlay" *ngIf="mostrarChatModal" (click)="cerrarChat()">
  <div class="chat-modal" (click)="$event.stopPropagation()">
    <div class="chat-header">
      <h3>Chat - {{ incidenciaSeleccionada?.titulo }}</h3>
      <button class="close-button" (click)="cerrarChat()">×</button>
    </div>
    
    <div class="chat-messages" *ngIf="!cargandoMensajes">
      <div *ngIf="mensajes.length === 0" class="chat-empty">
        <span class="app-icon">chat</span>
        <p>No hay mensajes aún</p>
        <small>Inicia la conversación escribiendo un mensaje</small>
      </div>
      
      <div *ngFor="let mensaje of mensajes" 
           class="mensaje" 
           [class.mensaje-propio]="esMiMensaje(mensaje)"
           [class.mensaje-otro]="!esMiMensaje(mensaje)">
        <div class="mensaje-header">
          <span class="mensaje-autor">{{ mensaje.usuario_nombre }}</span>
          <span class="mensaje-rol">({{ getRolLabel(mensaje.usuario_rol) }})</span>
          <span class="mensaje-fecha">{{ formatearFecha(mensaje.creado_en) }}</span>
          <button *ngIf="puedeEliminarMensaje(mensaje)" 
                  class="mensaje-delete" 
                  (click)="eliminarMensaje(mensaje)"
                  title="Eliminar mensaje">×</button>
        </div>
        <div class="mensaje-contenido">{{ mensaje.contenido }}</div>
      </div>
    </div>
    
    <div class="chat-loading" *ngIf="cargandoMensajes">
      <span class="app-icon spin">sync</span> Cargando mensajes...
    </div>
    
    <div class="chat-input">
      <input type="text" 
             [(ngModel)]="nuevoMensaje" 
             placeholder="Escribe un mensaje..." 
             (keyup.enter)="enviarMensaje()"
             maxlength="2000">
      <button class="send-btn" (click)="enviarMensaje()" [disabled]="!nuevoMensaje.trim()">
        <span class="app-icon">send</span>
      </button>
    </div>
  </div>
</div>

